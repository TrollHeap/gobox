package gpu

import (
	"fmt"
	"os"
	"path/filepath"
	"regexp"
)

type GPUInfo struct {
	Model       string
	Vendor      string
	Driver      string
	API         string
	Version     string
	Outputs     []string
	DisplayInfo string
	Message     string
}

type GPUDevice struct {
	Path   string
	Vendor string
	Device string
}

func FindGPUDevices() ([]string, error) {
	cards := []string{}
	pathDrm := "/sys/class/drm/"
	cardNum := regexp.MustCompile("^card[0-9]+$")

	entries, err := os.ReadDir(pathDrm)
	if err != nil {
		return nil, fmt.Errorf("impossible de lire %s: %w", pathDrm, err)
	}

	for _, entry := range entries {
		if cardNum.MatchString(entry.Name()) {
			path := filepath.Join(pathDrm, entry.Name())
			cards = append(cards, path)
		}
	}

	return cards, err
}

// NOTE: Path for testing
// cat /sys/class/drm/card1/device/vendor
// ───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//        │ File: /sys/class/drm/card1/device/vendor
// ───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//    1   │ 0x10de
// ───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//
// cat /sys/class/drm/card1/device/device
// ───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//        │ File: /sys/class/drm/card1/device/device
// ───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//    1   │ 0x2860
// ───────┴──────────────────────────────────────────
//
// ls /sys/class/drm/*/status
//  /sys/class/drm/card1-DP-1/status   /sys/class/drm/card1-DP-2/status   /sys/class/drm/card1-eDP-1/status   /sys/class/drm/card1-HDMI-A-1/status
//
// cat /sys/class/drm/card1-HDMI-A-1/status
// ───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//        │ File: /sys/class/drm/card1-HDMI-A-1/status
// ───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
//    1   │ disconnected
// ───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
